<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2FA éªŒè¯å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #f72585;
      --background-color: #f8f9fa;
      --card-bg: #ffffff;
      --card-gradient: linear-gradient(135deg, #ffffff, #f8f9fa);
      --code-color: #4361ee;
      --code-shadow: 0 2px 10px rgba(67, 97, 238, 0.15);
      --text-color: #333333;
      --text-light: #666666;
      --success-color: #4caf50;
      --danger-color: #f44336;
      --border-radius: 12px;
      --shadow: 0 10px 20px rgba(0,0,0,0.05);
      --card-shadow: 0 15px 25px rgba(0,0,0,0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }

    body {
      background: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
    }

    .container {
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      width: 100%;
      transition: var(--transition);
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 15px;
      position: relative;
      display: inline-block;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: var(--accent-color);
      border-radius: 2px;
    }

    .input-container {
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      transition: var(--transition);
    }

    .input-container:hover {
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }

    .input-group {
      display: flex;
      margin-bottom: 15px;
      align-items: center;
    }

    input {
      flex: 1;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius);
      margin-right: 15px;
      font-size: 16px;
      transition: var(--transition);
    }

    input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      outline: none;
    }

    .search-box {
      position: relative;
    }

    .search-box::before {
      content: 'ğŸ”';
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      color: #999;
    }

    .search-box input {
      padding-left: 45px;
    }

    button {
      padding: 15px 25px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .card {
      background: var(--card-gradient);
      border-radius: var(--border-radius);
      padding: 16px 20px 16px 16px;
      box-shadow: var(--card-shadow);
      position: relative;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.05);
      /* æ›¿æ¢é¡¶éƒ¨æ¡ä¸ºå·¦ä¾§å½©è‰²è¾¹æ¡† */
      border-left: 4px solid var(--primary-color);
    }
    
    /* è´¦æˆ·å›¾æ ‡æ ·å¼ */
    .account-icon {
      position: absolute;
      top: 12px;
      left: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      background: var(--primary-color);
      font-size: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .account-icon img {
      width: 20px;
      height: 20px;
      object-fit: contain;
    }
    
    .account-icon i {
      font-size: 16px;
    }

    .card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 20px 30px rgba(0,0,0,0.12);
    }
    
    /* ä¸ºä¸åŒçš„å¡ç‰‡æ·»åŠ ä¸åŒçš„è¾¹æ¡†è‰²å½© */
    .card:nth-child(3n) {
      border-left-color: var(--accent-color);
    }
    
    .card:nth-child(3n+1) {
      border-left-color: var(--secondary-color);
    }

    .card .label {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-color);
      word-break: break-word;
      padding-right: 30px; /* Space for delete button */
      padding-left: 42px; /* Space for icon */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card .code {
      font-size: 28px;
      font-weight: 700;
      margin: 12px 0;
      color: var(--code-color);
      letter-spacing: 1px;
      word-break: break-word;
      text-align: center;
      text-shadow: var(--code-shadow);
      font-family: 'Courier New', monospace;
      min-width: 240px; /* ç¡®ä¿éªŒè¯ç åŒºåŸŸæœ‰è¶³å¤Ÿå®½åº¦ */
    }

    .card .remaining {
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: auto;
      padding: 2px 0;
    }

    .progress-bar {
      height: 4px;
      background: rgba(0,0,0,0.06);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
      width: 100%;
    }

    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      transition: width 1s linear;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(67, 97, 238, 0.3);
    }

    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      color: var(--text-light);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.4;
      transition: var(--transition);
      z-index: 2;
    }

    .delete-btn:hover {
      opacity: 1;
      color: var(--danger-color);
      transform: rotate(90deg);
      background: rgba(244, 67, 54, 0.1);
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 300px;
      background: var(--primary-color);
      color: white;
      padding: 30px 20px;
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 5px 0 15px rgba(0,0,0,0.1);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar h3 {
      font-size: 24px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }

    .sidebar p {
      margin-bottom: 15px;
      line-height: 1.8;
    }

    .sidebar-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 22px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .sidebar-toggle:hover {
      background: var(--secondary-color);
      transform: rotate(90deg);
    }

    .sidebar-content {
      padding: 15px 0;
    }
    
    .sidebar-section {
      margin-bottom: 25px;
    }

    .sidebar-section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* æ‹–æ”¾åŒºåŸŸæ ·å¼ */
    .dropzone-container {
      margin-top: 10px;
      overflow: hidden;
      transition: var(--transition);
      max-height: 0; /* é»˜è®¤æŠ˜å  */
    }
    
    .dropzone-container.expanded {
      max-height: 150px; /* å±•å¼€æ—¶çš„é«˜åº¦ */
    }
    
    .dropzone-toggle {
      cursor: pointer;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .dropzone {
      border: 2px dashed #ccc;
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
      transition: var(--transition);
    }

    .dropzone.highlight {
      border-color: var(--primary-color);
      background-color: rgba(67, 97, 238, 0.05);
    }
    
    .dropzone i {
      font-size: 48px;
      color: #ccc;
      margin-bottom: 15px;
    }
    
    .dropzone p {
      color: var(--text-light);
    }

    /* ä¸€äº›åŠ¨ç”»æ•ˆæœ */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    /* å¤åˆ¶æˆåŠŸæç¤º */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary-color);
      color: white;
      padding: 15px 25px;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      z-index: 1000;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 20px auto;
      }
      
      .card-container {
        grid-template-columns: 1fr;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      input {
        margin-right: 0;
        margin-bottom: 10px;
        width: 100%;
      }
      
      button {
        width: 100%;
      }
      
      .sidebar {
        width: 85%;
      }
    }
    
    /* æš—è‰²æ¨¡å¼æ”¯æŒ */
    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #121212;
        --card-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --text-light: #a0a0a0;
        --shadow: 0 10px 20px rgba(0,0,0,0.2);
      }
      
      input {
        background: #2a2a2a;
        border-color: #333;
        color: var(--text-color);
      }
    }
    
    /* åŠ¨ç”»ç±» */
    .fade-in {
      animation: fadeIn 0.5s forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <button class="sidebar-toggle" id="sidebarToggle">
    <i class="fas fa-book"></i>
  </button>
  
  <div class="sidebar" id="sidebar">
    <h3>ä½¿ç”¨è¯´æ˜</h3>
    
    <div class="sidebar-content">
      <div class="sidebar-section">
        <div class="sidebar-section-title">
          <i class="fas fa-plus-circle"></i> æ·»åŠ è´¦æˆ·
        </div>
        <p>â€¢ è¾“å…¥ TOTP URI æˆ– Secret åç‚¹å‡»æ·»åŠ </p>
        <p>â€¢ ç²˜è´´äºŒç»´ç å›¾ç‰‡æˆ–æ‹–å…¥å›¾ç‰‡è‡ªåŠ¨è§£æ</p>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">
          <i class="fas fa-copy"></i> ä½¿ç”¨éªŒè¯ç 
        </div>
        <p>â€¢ ç‚¹å‡»å¡ç‰‡å¯å¿«é€Ÿå¤åˆ¶éªŒè¯ç </p>
        <p>â€¢ æœç´¢æ¡†å¯å¿«é€ŸæŸ¥æ‰¾è´¦æˆ·</p>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">
          <i class="fas fa-shield-alt"></i> éšç§è¯´æ˜
        </div>
        <p>â€¢ æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</p>
        <p>â€¢ ä¸ä¸Šä¼ ã€ä¸æ”¶é›†ä»»ä½•æ•°æ®</p>
        <p>â€¢ æ²¡æœ‰ç½‘ç»œè¯·æ±‚ï¼Œä¿éšœæ‚¨çš„éšç§å®‰å…¨</p>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <h1>2FA éªŒè¯å™¨</h1>
    </header>
    
    <div class="input-container">
      <div class="input-group">
        <input type="text" id="input" placeholder="è¾“å…¥ TOTP URI æˆ– Secret">
        <button onclick="addAccount()">
          <i class="fas fa-plus"></i> æ·»åŠ è´¦æˆ·
        </button>
      </div>
      
      <div class="input-group search-box">
        <input type="text" id="search" placeholder="æœç´¢è´¦æˆ·..." oninput="renderAccounts()">
      </div>
      
      <div class="dropzone-toggle" id="dropzoneToggle">
        <i class="fas fa-plus-circle"></i> æ˜¾ç¤ºäºŒç»´ç ä¸Šä¼ åŒºåŸŸ
      </div>
      <div class="dropzone-container" id="dropzoneContainer">
        <div class="dropzone" id="dropzone">
          <i class="fas fa-qrcode"></i>
          <p>æ‹–æ”¾äºŒç»´ç å›¾ç‰‡è‡³æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ç²˜è´´äºŒç»´ç å›¾ç‰‡</p>
        </div>
      </div>
    </div>
    
    <div class="card-container" id="accounts"></div>
  </div>
  
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i> <span id="toastMessage">éªŒè¯ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    // åˆå§‹åŒ–æ•°æ®
    let accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
    
    // å¦‚æœæ²¡æœ‰è´¦æˆ·ï¼Œæ·»åŠ ä¸€äº›æµ‹è¯•è´¦æˆ·ï¼ˆä»…ç”¨äºå±•ç¤ºUIæ•ˆæœï¼‰
    if (accounts.length === 0) {
      accounts = [
        { label: 'Googleè´¦æˆ·', secret: 'JBSWY3DPEHPK3PXP', issuedTime: Date.now() },
        { label: 'GitHub', secret: 'NBSWY3DPFXPK3PQR', issuedTime: Date.now() },
        { label: 'éå¸¸é•¿çš„è´¦æˆ·åç§°ä¼šè¢«æˆªæ–­æ˜¾ç¤ºæµ‹è¯•', secret: 'HBSWY3DPEEPK3PXP', issuedTime: Date.now() },
        { label: 'Microsoft', secret: 'KBSXY3DPEHPK3PXO', issuedTime: Date.now() }
      ];
      // ä¸è‡ªåŠ¨ä¿å­˜åˆ°localStorageï¼Œè¿™æ ·åˆ·æ–°é¡µé¢åä¼šæ¢å¤ç©ºçŠ¶æ€
    }
    const input = document.getElementById('input');
    const search = document.getElementById('search');
    const accountsDiv = document.getElementById('accounts');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const toast = document.getElementById('toast');
    const dropzone = document.getElementById('dropzone');
    
    // ä¾§è¾¹æ åˆ‡æ¢
    sidebarToggle.onclick = () => {
      sidebar.classList.toggle('open');
      sidebarToggle.classList.toggle('active');
    };
    
    // è§£æ TOTP Secret
    function parseSecret(str) {
      try {
        str = str.trim();
        if (str.toLowerCase().startsWith('otpauth://')) {
          const url = new URL(str);
          const secret = url.searchParams.get('secret');
          const label = decodeURIComponent(url.pathname.split('/').pop() || '');
          return { secret, label };
        }
      } catch (e) {
        console.error('è§£æ URI å¤±è´¥:', e);
      }
      return { secret: str.replace(/\s+/g, ''), label: '' };
    }
    
    // æ·»åŠ è´¦æˆ·
    function addAccount() {
      const inputValue = input.value.trim();
      if (!inputValue) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ TOTP URI æˆ– Secret', 'error');
        return;
      }
      
      const { secret, label: parsedLabel } = parseSecret(inputValue);
      
      if (!secret) {
        showToast('æ— æ•ˆçš„ Secret', 'error');
        return;
      }
      
      // å¦‚æœä» URI è§£æå‡ºæ ‡ç­¾ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™æç¤ºç”¨æˆ·è¾“å…¥
      const label = parsedLabel || prompt('è¾“å…¥è´¦æˆ·æ ‡ç­¾', 'æœªå‘½åè´¦æˆ·') || 'æœªå‘½åè´¦æˆ·';
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è´¦æˆ·
      const exists = accounts.some(acc => acc.secret === secret);
      if (exists) {
        showToast('æ­¤è´¦æˆ·å·²å­˜åœ¨', 'error');
        return;
      }
      
      // æ·»åŠ åŠ¨ç”»æ•ˆæœ
      const newAccount = { label, secret, isNew: true };
      accounts.push(newAccount);
      saveAndRender();
      input.value = '';
      
      // æç¤ºæ·»åŠ æˆåŠŸ
      showToast(`è´¦æˆ· "${label}" æ·»åŠ æˆåŠŸ`);
      
      // ä¸€æ®µæ—¶é—´åç§»é™¤æ–°å¢æ ‡è®°
      setTimeout(() => {
        newAccount.isNew = false;
        saveAndRender();
      }, 3000);
    }
    
    // åˆ é™¤è´¦æˆ·
    function deleteAccount(i, event) {
      event.stopPropagation();
      if (confirm(`ç¡®å®šè¦åˆ é™¤è´¦æˆ· "${accounts[i].label}" å—ï¼Ÿ`)) {
        accounts.splice(i, 1);
        saveAndRender();
        showToast('è´¦æˆ·å·²åˆ é™¤');
      }
    }
    
    // ä¿å­˜å¹¶æ¸²æŸ“
    function saveAndRender() {
      localStorage.setItem('accounts', JSON.stringify(accounts));
      renderAccounts();
    }
    
    // ç”Ÿæˆ TOTP éªŒè¯ç 
    function generateTOTP(secret) {
      try {
        const key = base32tohex(secret);
        const epoch = Math.round(new Date().getTime() / 1000.0);
        const time = leftpad(dec2hex(Math.floor(epoch / 30)), 16, '0');
        
        // ä½¿ç”¨ jsSHA è®¡ç®— HMAC
        const hmacObj = new jsSHA('SHA-1', 'HEX');
        hmacObj.setHMACKey(key, 'HEX');
        hmacObj.update(time);
        const hmac = hmacObj.getHMAC('HEX');
        
        const offset = hex2dec(hmac.substring(hmac.length - 1));
        const truncatedHash = (hex2dec(hmac.substr(offset * 2, 8)) & hex2dec('7fffffff')) + '';
        return truncatedHash.substr(truncatedHash.length - 6, 6);
      } catch (e) {
        console.error('ç”Ÿæˆ TOTP å¤±è´¥:', e);
        return '------';
      }
    }
    
    // æ¸²æŸ“è´¦æˆ·åˆ—è¡¨ï¼ˆåˆå§‹æ¸²æŸ“ï¼‰
    function renderAccounts() {
      accountsDiv.innerHTML = '';
      const filter = search.value.toLowerCase();
      
      const filteredAccounts = accounts.filter(acc => {
        // é˜²å¾¡æ€§æ£€æŸ¥ï¼Œç¡®ä¿å±æ€§å­˜åœ¨
        const labelMatch = acc.label && typeof acc.label === 'string' ? 
          acc.label.toLowerCase().includes(filter) : false;
        const secretMatch = acc.secret && typeof acc.secret === 'string' ? 
          acc.secret.toLowerCase().includes(filter) : false;
        return labelMatch || secretMatch;
      });
      
      if (filteredAccounts.length === 0) {
        accountsDiv.innerHTML = `
          <div style="text-align: center; grid-column: 1/-1; padding: 30px; color: var(--text-light);">
            ${filter ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è´¦æˆ·' : 'è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è´¦æˆ·'}
            <div style="margin-top: 15px; font-size: 32px;">
              <i class="fas ${filter ? 'fa-search' : 'fa-qrcode'}"></i>
            </div>
          </div>
        `;
        return;
      }
      
      // åˆ›å»ºæ‰€æœ‰å¡ç‰‡å…ƒç´ 
      filteredAccounts.forEach((acc, i) => {
        const originalIndex = accounts.indexOf(acc);
        const card = document.createElement('div');
        card.className = `card ${acc.isNew ? 'pulse' : ''} fade-in`;
        card.id = `card-${originalIndex}`;
        
        // è®¡ç®—è¿›åº¦æ¡å®½åº¦
        const progressWidth = acc.remaining ? ((30 - acc.remaining) / 30) * 100 : 0;
        
        card.onclick = () => {
          navigator.clipboard.writeText(acc.code || '------')
            .then(() => showToast(`å·²å¤åˆ¶ ${acc.label} çš„éªŒè¯ç `))
            .catch(() => showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error'));
        };
        
        // è·å–è´¦æˆ·å›¾æ ‡
        const iconHTML = getIconForAccount(acc.label, originalIndex % 3);
        
        card.innerHTML = `
          <button class="delete-btn" title="åˆ é™¤æ­¤è´¦æˆ·" onclick="deleteAccount(${originalIndex}, event)">
            <i class="fas fa-times"></i>
          </button>
          <div class="account-icon" style="background: ${getIconColor(originalIndex % 3)}">
            ${iconHTML}
          </div>
          <div class="label" title="${escapeHTML(acc.label)}">${escapeHTML(acc.label)}</div>
          <div class="code" id="code-${originalIndex}">${formatCode(acc.code || '------')}</div>
          <div class="remaining">
            <span id="remain-time-${originalIndex}">å‰©ä½™ ${acc.remaining || 30} ç§’</span>
            <span id="issued-time-${originalIndex}">${acc.issuedTime ? new Date(acc.issuedTime).toLocaleTimeString() : ''}</span>
          </div>
          <div class="progress-bar">
            <div class="progress" id="progress-${originalIndex}" style="width: ${progressWidth}%"></div>
          </div>
        `;
        
        accountsDiv.appendChild(card);
      });
    }
    
    // æ›´æ–°éªŒè¯ç ï¼ˆåªæ›´æ–°éœ€è¦å˜åŒ–çš„éƒ¨åˆ†ï¼‰
    function updateCodes() {
      const epoch = Math.floor(Date.now() / 1000);
      const remain = 30 - (epoch % 30);
      
      // åªæœ‰åœ¨å‰©ä½™æ—¶é—´å˜åŒ–æ—¶æ‰æ›´æ–° UI
      const needsUpdate = !accounts.length || accounts.some(acc => acc.remaining !== remain);
      
      if (needsUpdate) {
        accounts.forEach((acc, index) => {
          // æ›´æ–°æ•°æ®
          acc.code = generateOtp(acc.secret);
          acc.remaining = remain;
          acc.issuedTime = Date.now();
          
          // å±€éƒ¨æ›´æ–°DOMï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªå¡ç‰‡
          const codeElement = document.getElementById(`code-${index}`);
          const remainTimeElement = document.getElementById(`remain-time-${index}`);
          const progressElement = document.getElementById(`progress-${index}`);
          const issuedTimeElement = document.getElementById(`issued-time-${index}`);
          
          if (codeElement) codeElement.innerHTML = formatCode(acc.code || '------');
          if (remainTimeElement) remainTimeElement.textContent = `å‰©ä½™ ${acc.remaining || 30} ç§’`;
          if (progressElement) progressElement.style.width = `${((30 - acc.remaining) / 30) * 100}%`;
          if (issuedTimeElement && acc.issuedTime) {
            issuedTimeElement.textContent = new Date(acc.issuedTime).toLocaleTimeString();
          }
        });
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å…ƒç´ (å¯èƒ½æ˜¯æœç´¢è¿‡æ»¤å¯¼è‡´)ï¼Œé‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
        if (accounts.length > 0 && !document.getElementById(`code-0`)) {
          renderAccounts();
        }
      }
    }
    
    // å®šæ—¶æ›´æ–°éªŒè¯ç 
    setInterval(updateCodes, 1000);
    updateCodes(); // åˆå§‹æ›´æ–°
    
    // è¾…åŠ©å‡½æ•° - æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message, type = 'success') {
      const toastElement = document.getElementById('toast');
      const messageElement = document.getElementById('toastMessage');
      
      messageElement.textContent = message;
      toastElement.className = `toast show ${type}`;
      
      if (type === 'error') {
        toastElement.style.background = 'var(--danger-color)';
      } else {
        toastElement.style.background = 'var(--success-color)';
      }
      
      setTimeout(() => {
        toastElement.className = 'toast';
      }, 3000);
    }
    
    // è¾…åŠ©å‡½æ•° - HTML è½¬ä¹‰
    // è·å–è´¦æˆ·å›¾æ ‡çš„å‡½æ•°ï¼ˆä½¿ç”¨Font Awesomeå›¾æ ‡æ›¿ä»£å¤–éƒ¨SVGï¼‰
    function getIconForAccount(accountName, colorIndex) {
      // å¸¸è§ç½‘ç«™çš„Font Awesomeå›¾æ ‡æ˜ å°„
      const knownSites = {
        'github': '<i class="fab fa-github"></i>',
        'google': '<i class="fab fa-google"></i>',
        'outlook': '<i class="far fa-envelope"></i>',
        'twitter': '<i class="fab fa-twitter"></i>',
        'microsoft': '<i class="fab fa-microsoft"></i>',
        'apple': '<i class="fab fa-apple"></i>',
        'amazon': '<i class="fab fa-amazon"></i>',
        'facebook': '<i class="fab fa-facebook"></i>',
        'instagram': '<i class="fab fa-instagram"></i>',
        'linkedin': '<i class="fab fa-linkedin"></i>',
        'discord': '<i class="fab fa-discord"></i>',
        'gitlab': '<i class="fab fa-gitlab"></i>',
        'bitbucket': '<i class="fab fa-bitbucket"></i>',
        'dropbox': '<i class="fab fa-dropbox"></i>',
        'slack': '<i class="fab fa-slack"></i>',
        'steam': '<i class="fab fa-steam"></i>',
        'gmail': '<i class="far fa-envelope"></i>',
        'yahoo': '<i class="fab fa-yahoo"></i>',
        'twitch': '<i class="fab fa-twitch"></i>',
        'reddit': '<i class="fab fa-reddit"></i>'
      };
      
      if (!accountName) return '?';
      
      // åŒ¹é…é€»è¾‘ä¼˜åŒ–ï¼šä¼˜å…ˆåŒ¹é…å®Œæ•´å•è¯
      const lowerName = accountName.toLowerCase();
      
      // 1. ç²¾ç¡®åŒ¹é… - å°è¯•æŸ¥æ‰¾å®Œæ•´å•è¯åŒ¹é…
      for (const site in knownSites) {
        // æ£€æŸ¥æ˜¯å¦ä¸ºç‹¬ç«‹å•è¯ï¼ˆå‰åæ˜¯éå­—æ¯æ•°å­—å­—ç¬¦æˆ–å­—ç¬¦ä¸²è¾¹ç•Œï¼‰
        const regex = new RegExp(`(^|[^a-z0-9])${site}([^a-z0-9]|$)`, 'i');
        if (regex.test(lowerName)) {
          return knownSites[site];
        }
      }
      
      // 2. æ™®é€šåŒ¹é… - æŸ¥æ‰¾æ˜¯å¦åŒ…å«ç½‘ç«™å
      for (const site in knownSites) {
        if (lowerName.includes(site)) {
          return knownSites[site];
        }
      }
      
      // å¦åˆ™è¿”å›é¦–å­—æ¯
      const firstChar = accountName.trim()[0] || '?';
      return firstChar.toUpperCase();
    }
    
    // è·å–å›¾æ ‡èƒŒæ™¯è‰²
    function getIconColor(index) {
      const colors = [
        'var(--primary-color)',    // è“è‰²
        'var(--secondary-color)',  // æ·±è“è‰²
        'var(--accent-color)'      // ç²‰è‰²
      ];
      return colors[index % colors.length];
    }

    function escapeHTML(str) {
      // é˜²å¾¡æ€§æ£€æŸ¥ï¼Œç¡®ä¿è¾“å…¥ä¸ºå­—ç¬¦ä¸²
      if (str === undefined || str === null || typeof str !== 'string') {
        return '';
      }
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // å·¥å…·å‡½æ•°
    function dec2hex(s) { return (s < 15.5 ? '0' : '') + Math.round(s).toString(16); }
    function hex2dec(s) { return parseInt(s, 16); }
    
    function leftpad(s, l, p) { 
      return s.length >= l ? s : Array(l - s.length + 1).join(p) + s; 
    }
    
    // éªŒè¯ç æ ¼å¼åŒ–å‡½æ•° - å°†6ä½æ•°å­—åˆ†ä¸º2ç»„ï¼Œæé«˜å¯è¯»æ€§
    function formatCode(code) {
      if (code === '------') return code;
      
      // å¦‚æœæ˜¯6ä½æ•°å­—ï¼Œåˆ†ç»„æ˜¾ç¤º
      if (/^\d{6}$/.test(code)) {
        return `${code.substr(0, 3)}<span style="margin: 0 4px"></span>${code.substr(3, 3)}`;
      }
      
      return code;
    }
    
    function base32tohex(base32) {
      const base32chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = '';
      let hex = '';
      
      base32 = base32.replace(/=+$/, '').toUpperCase();
      
      for (let i = 0; i < base32.length; i++) {
        const val = base32chars.indexOf(base32.charAt(i));
        if (val === -1) continue;
        bits += leftpad(val.toString(2), 5, '0');
      }
      
      for (let i = 0; i + 4 <= bits.length; i += 4) {
        const chunk = bits.substr(i, 4);
        hex += parseInt(chunk, 2).toString(16);
      }
      
      return hex;
    }
    
    function generateOtp(secret) {
      if (!secret || typeof secret !== 'string') {
        return '------';
      }
      
      try {
        const epoch = Math.round(new Date().getTime() / 1000.0);
        const time = leftpad(dec2hex(Math.floor(epoch / 30)), 16, '0');
        
        // ç¡®ä¿ jsSHA å·²å®šä¹‰
        if (typeof jsSHA === 'undefined') {
          console.error('jsSHA åº“æœªåŠ è½½');
          return '------';
        }
        
        const crypto = new jsSHA('SHA-1', 'HEX');
        crypto.setHMACKey(base32tohex(secret), 'HEX');
        crypto.update(time);
        const hmac = crypto.getHMAC('HEX');
        
        const offset = hex2dec(hmac.substring(hmac.length - 1));
        const truncatedHash = (hex2dec(hmac.substr(offset * 2, 8)) & hex2dec('7fffffff')) + '';
        return truncatedHash.substr(truncatedHash.length - 6, 6);
      } catch (e) {
        console.error('ç”Ÿæˆ OTP å¤±è´¥:', e, secret);
        return '------';
      }
    }
    
    // æ‹–æ”¾åŠŸèƒ½
    function setupDropzone() {
      const dropzone = document.getElementById('dropzone');
      
      // é˜²æ­¢æ–‡ä»¶è¢«æµè§ˆå™¨å¤„ç†è€Œä¸æ˜¯è¢«æ‹–æ”¾å¤„ç†
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });
      
      // æ‹–æ‹½çŠ¶æ€é«˜äº®
      ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
          dropzone.classList.add('highlight');
        }, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
          dropzone.classList.remove('highlight');
        }, false);
      });
      
      // å¤„ç†æ‹–æ”¾çš„æ–‡ä»¶
      dropzone.addEventListener('drop', event => {
        const dt = event.dataTransfer;
        const files = dt.files;
        
        if (files.length) {
          handleFiles(files);
        }
      }, false);
      
      // ä¹Ÿå¯ä»¥ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
      dropzone.addEventListener('click', () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.onchange = e => {
          if (e.target.files.length) {
            handleFiles(e.target.files);
          }
        };
        fileInput.click();
      });
    }
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    function handleFiles(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      if (!file.type.match('image.*')) {
        showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
        return;
      }
      
      processQrCode(file);
    }
    
    function processQrCode(file) {
      const reader = new FileReader();
      
      reader.onload = function(event) {
        const img = new Image();
        
        img.onload = function() {
          const canvas = document.getElementById('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          
          try {
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
              const data = code.data;
              input.value = data;
              showToast('äºŒç»´ç è§£ææˆåŠŸï¼Œè¯·ç‚¹å‡»æ·»åŠ è´¦æˆ·');
              
              // å¦‚æœæ˜¯ TOTP URIï¼Œè‡ªåŠ¨æ·»åŠ 
              if (data.toLowerCase().startsWith('otpauth://')) {
                const { secret, label } = parseSecret(data);
                if (secret) {
                  const exists = accounts.some(acc => acc.secret === secret);
                  if (!exists) {
                    accounts.push({ label: label || 'æ‰«æçš„è´¦æˆ·', secret, isNew: true });
                    saveAndRender();
                    input.value = '';
                    showToast(`è´¦æˆ· "${label || 'æ‰«æçš„è´¦æˆ·'}" å·²è‡ªåŠ¨æ·»åŠ `);
                    
                    setTimeout(() => {
                      const lastAccount = accounts[accounts.length - 1];
                      if (lastAccount) {
                        lastAccount.isNew = false;
                        saveAndRender();
                      }
                    }, 3000);
                  } else {
                    showToast('æ­¤è´¦æˆ·å·²å­˜åœ¨', 'error');
                  }
                } else {
                  showToast('æ— æ•ˆçš„ TOTP URI', 'error');
                }
              }
            } else {
              showToast('æœªè¯†åˆ«åˆ°äºŒç»´ç ', 'error');
            }
          } catch (e) {
            console.error('è§£æäºŒç»´ç å¤±è´¥:', e);
            showToast('è§£æäºŒç»´ç å¤±è´¥', 'error');
          }
        };
        
        img.src = event.target.result;
      };
      
      reader.readAsDataURL(file);
    }
    
    // ç²˜è´´å›¾ç‰‡åŠŸèƒ½
    document.addEventListener('paste', e => {
      const items = e.clipboardData.items;
      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          const blob = item.getAsFile();
          processQrCode(blob);
          break;
        }
      }
    });
    
    // åˆå§‹åŒ–
    function init() {
      setupDropzone();
      setupDropzoneToggle();
      renderAccounts();
    }
    
    // è®¾ç½®äºŒç»´ç åŒºåŸŸçš„æŠ˜å /å±•å¼€åŠŸèƒ½
    function setupDropzoneToggle() {
      const toggle = document.getElementById('dropzoneToggle');
      const container = document.getElementById('dropzoneContainer');
      
      toggle.addEventListener('click', () => {
        container.classList.toggle('expanded');
        if (container.classList.contains('expanded')) {
          toggle.innerHTML = '<i class="fas fa-minus-circle"></i> éšè—äºŒç»´ç ä¸Šä¼ åŒºåŸŸ';
        } else {
          toggle.innerHTML = '<i class="fas fa-plus-circle"></i> æ˜¾ç¤ºäºŒç»´ç ä¸Šä¼ åŒºåŸŸ';
        }
      });
    }
    
    init();
  </script>

  <!-- å·²åœ¨å¤´éƒ¨åŠ è½½ jsSHA -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
</body>
</html>
