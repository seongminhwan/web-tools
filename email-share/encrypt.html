<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>邮箱账号加密工具</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4285F4; /* Google蓝 */
      --primary-dark: #3367d6; /* 深蓝色，用于悬停状态 */
      --secondary-color: #34A853; /* Google绿 */
      --accent-color: #EA4335; /* Google红 */
      --warning-color: #FBBC05; /* Google黄 */
      --background-color: #f8f9fa;
      --card-bg: #ffffff;
      --text-color: #333333;
      --text-light: #666666;
      --border-radius: 12px;
      --shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s ease;
    }
    
    .required {
      color: var(--accent-color);
      font-weight: bold;
    }
    
    .optional {
      color: var(--text-light);
      font-size: 0.9em;
      font-weight: normal;
    }
    
    .password-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .password-container input {
      flex: 1;
    }
    
    .btn-sm {
      padding: 8px 12px;
      font-size: 14px;
      white-space: nowrap;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }

    body {
      background: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      width: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 15px;
      position: relative;
      display: inline-block;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: var(--accent-color);
      border-radius: 2px;
    }

    p.subtitle {
      color: var(--text-light);
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    /* 左右两栏布局 */
    .form-container {
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }
    
    .two-column-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    .left-column {
      border-right: 1px solid #eee;
      padding-right: 20px;
    }
    
    .right-column {
      padding-left: 10px;
    }

    .section-title {
      font-size: 1.3rem;
      color: var(--primary-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="tel"],
    textarea,
    select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: var(--transition);
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
      outline: none;
    }

    .totp-container {
      display: flex;
      gap: 15px;
    }

    .totp-container input {
      flex: 1;
    }

    .btn {
      padding: 14px 25px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn:hover {
      background: #3367d6;
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-warning {
      background: var(--warning-color);
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-danger {
      background: var(--accent-color);
    }

    .btn-danger:hover {
      background: #c62828;
    }

    .btn-success {
      background: var(--secondary-color);
    }

    .btn-success:hover {
      background: #2e7d32;
    }

    .btn-container {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: flex-end;
    }

    /* 两列布局 */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-column {
      flex: 1;
      min-width: 250px;
    }
    
    /* 2FA预览区域 */
    .preview-container {
      padding: 20px;
      background: #f5f5f5;
      border-radius: var(--border-radius);
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .preview-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .totp-code-preview {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
      font-family: monospace;
      letter-spacing: 2px;
      margin: 15px 0;
      padding: 8px 16px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    
    /* 分享选项 */
    .share-options {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: var(--border-radius);
    }
    
    .option-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .option-group label {
      margin: 0 0 0 10px;
      font-weight: normal;
    }

    .result-container {
      display: none;
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-top: 20px;
    }

    .result-group {
      margin-bottom: 20px;
    }

    .result-label {
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
    }

    .result-value {
      padding: 15px;
      background: #f5f5f5;
      border-radius: var(--border-radius);
      font-family: monospace;
      word-break: break-all;
      position: relative;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 5px 10px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
    }

    .copy-btn:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      color: white;
      background: var(--accent-color);
    }

    .alert-warning {
      background: var(--warning-color);
      color: #333;
    }

    .alert-info {
      background: var(--primary-color);
    }

    .qrcode-container {
      text-align: center;
      margin-top: 20px;
    }

    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    footer {
      text-align: center;
      margin-top: auto;
      padding: 20px;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .preview-link {
      margin-top: 20px;
      text-align: center;
    }

    .preview-link a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
    }

    .preview-link a:hover {
      text-decoration: underline;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
      font-weight: 600;
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    /* 邮箱输入组样式 */
    .email-input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .email-separator {
      margin: 0 5px;
      font-weight: bold;
    }
    
    #emailPrefix {
      flex: 3;
      min-width: 100px;
    }
    
    #emailDomain {
      flex: 1;
      max-width: 240px;
      width: 180px;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: var(--transition);
      background-color: white;
    }
    
    #customDomain {
      flex: 1;
      max-width: 150px;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: var(--transition);
    }

    /* 模态框样式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: var(--card-bg);
      margin: 50px auto;
      width: 80%;
      max-width: 900px;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .modal-header {
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
    }

    .modal-close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      padding: 0 8px;
    }

    .modal-close:hover {
      color: #ddd;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 15px 20px;
      background-color: #f5f5f5;
      text-align: right;
      border-top: 1px solid #ddd;
    }

    .notes-container {
      display: flex;
      gap: 20px;
      height: 300px;
    }

    .notes-input {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .notes-input textarea {
      flex: 1;
      resize: none;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      font-size: 15px;
    }

    .notes-preview {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .notes-preview .preview-title {
      padding: 8px 12px;
      background-color: #f5f5f5;
      border-bottom: 1px solid #ddd;
      font-weight: 600;
    }

    .notes-preview .markdown-content {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      background-color: white;
    }

    /* 备注按钮样式 */
    .notes-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: var(--primary-color);
      transition: background-color 0.2s;
    }

    .notes-btn:hover {
      background-color: #e5e5e5;
    }

    .notes-btn i {
      font-size: 16px;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 20px auto;
      }

      h1 {
        font-size: 2rem;
      }

      .btn-container {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .totp-container {
        flex-direction: column;
      }
      
      .email-input-group {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .email-separator {
        margin: 5px 0;
      }
      
      #emailDomain, #emailPrefix {
        width: 100%;
      }
      
      .notes-container {
        flex-direction: column;
        height: auto;
      }
      
      .notes-input, .notes-preview {
        flex: none;
        height: 200px;
      }
    }

    /* 暗色模式 */
    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #121212;
        --card-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --text-light: #a0a0a0;
      }

      input, textarea, select {
        background: #2a2a2a;
        border-color: #333;
        color: var(--text-color);
      }

      .result-value {
        background: #2a2a2a;
      }
      
      .notes-btn {
        background-color: #2a2a2a;
        border-color: #444;
      }
      
      .notes-btn:hover {
        background-color: #333;
      }
      
      .notes-preview .preview-title {
        background-color: #2a2a2a;
        border-color: #444;
      }
      
      .notes-preview .markdown-content {
        background-color: #252525;
      }
      
      .modal-footer {
        background-color: #252525;
        border-color: #444;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>邮箱账号加密工具</h1>
      <p class="subtitle">安全地加密并分享您的邮箱账号信息</p>
    </header>

    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle"></i> 
      请注意：所有信息将在本地加密，我们不会向服务器发送任何数据。请妥善保管您的加密秘钥。
    </div>

    <div class="form-container">
      <form id="accountForm">
        <div class="two-column-layout">
          <div class="left-column">
            <h2 class="section-title">
              <i class="fas fa-user-shield"></i> 账号信息
            </h2>
            
            <div class="form-group">
              <label for="emailPrefix">邮箱账号 <span class="required">*</span></label>
              <div class="email-input-group">
                <input type="text" id="emailPrefix" placeholder="输入邮箱名" required>
                <span class="email-separator">@</span>
                <select id="emailDomain">
                  <option value="gmail.com" selected>gmail.com</option>
                  <option value="outlook.com">outlook.com</option>
                  <option value="yahoo.com">yahoo.com</option>
                  <option value="hotmail.com">hotmail.com</option>
                  <option value="163.com">163.com</option>
                  <option value="qq.com">qq.com</option>
                  <option value="126.com">126.com</option>
                  <option value="icloud.com">icloud.com</option>
                  <option value="custom">自定义...</option>
                </select>
                <input type="text" id="customDomain" placeholder="输入自定义域名" style="display:none; width:150px;">
                <button type="button" class="btn btn-sm" id="generateRandomEmail">
                  <i class="fas fa-random"></i> 随机生成
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="googlePassword">邮箱密码 <span class="required">*</span></label>
              <div class="password-container">
                <input type="text" id="googlePassword" placeholder="请输入密码" required>
                <button type="button" class="btn btn-sm" id="genPasswordBtn">
                  <i class="fas fa-dice"></i> 生成强密码
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="recoveryPhone">恢复手机号 <span class="optional">(选填)</span></label>
              <input type="tel" id="recoveryPhone" placeholder="+86 138****1234">
            </div>

            <div class="form-group">
              <label for="recoveryEmail">恢复邮箱 <span class="optional">(选填)</span></label>
              <input type="email" id="recoveryEmail" placeholder="recovery@example.com">
            </div>
            
            <div class="form-group">
              <label for="registrationTime">注册时间 <span class="optional">(选填)</span></label>
              <input type="text" id="registrationTime" placeholder="例如：2023-01-15">
            </div>

            <div class="form-group">
              <label for="registrationIP">注册IP <span class="optional">(选填)</span></label>
              <input type="text" id="registrationIP" placeholder="例如：192.168.1.1">
            </div>

            <div class="form-group">
              <label for="cookieInfo">Cookie信息 <span class="optional">(选填)</span></label>
              <textarea id="cookieInfo" rows="3" placeholder="请输入Cookie信息"></textarea>
            </div>
            
            <div class="form-group">
              <label>账号备注 <span class="optional">(选填，支持Markdown语法)</span></label>
              <button type="button" class="notes-btn" id="openNotesBtn">
                <i class="fas fa-edit"></i> 编辑账号备注
              </button>
              <div id="notesIndicator" style="margin-top: 8px; font-size: 14px; color: var(--text-light);"></div>
            </div>
          </div>
          
          <div class="right-column">
            <h2 class="section-title">
              <i class="fas fa-key"></i> 加密与预览
            </h2>
            
            <div class="form-group">
              <label for="totpUri">TOTP URI <span class="optional">(选填)</span></label>
              <div class="totp-container">
                <input type="text" id="totpUri" placeholder="otpauth://totp/Google:example@gmail.com?secret=...">
                <button type="button" class="btn btn-primary btn-sm" id="parseUriBtn">
                  <i class="fas fa-magic"></i> 解析URI
                </button>
              </div>
              <p class="help-text" style="font-size: 12px; margin-top: 5px; color: var(--text-light);">
                支持解析标准格式的TOTP URI，例如：otpauth://totp/Google%3Aarethai5c5j45%40gmail.com?secret=...
              </p>
            </div>

            <div class="form-group">
              <label for="totpSecret">2FA Secret (TOTP格式) <span class="optional">(选填)</span></label>
              <input type="text" id="totpSecret" placeholder="例如：JBSWY3DPEHPK3PXP" oninput="updateTFAPreview()">
              
              <div class="preview-container" id="tfaPreview" style="display: none;">
                <div class="preview-title">2FA 预览</div>
                <div id="qrcode-preview"></div>
                <div class="totp-code-preview" id="totp-code-preview" onclick="copyTOTP()">------</div>
                <div class="totp-timer" id="totp-timer">剩余时间: 30秒</div>
              </div>
            </div>

            <div class="form-group">
              <label for="encryptionKey">加密秘钥 (用于解密)</label>
              <div class="totp-container">
                <input type="text" id="encryptionKey" placeholder="请设置加密秘钥或自动生成">
                <button type="button" class="btn btn-warning" id="generateKeyBtn">
                  <i class="fas fa-key"></i> 生成秘钥
                </button>
              </div>
            </div>
            
            <div class="share-options">
              <div class="option-group">
                <input type="checkbox" id="includeKeyInUrl" checked>
                <label for="includeKeyInUrl">在分享URL中包含解密秘钥（默认选中，可直接打开）</label>
              </div>
            </div>
            
            <div class="btn-container">
              <button type="button" class="btn btn-danger" id="resetBtn">
                <i class="fas fa-trash-alt"></i> 重置
              </button>
              <button type="button" class="btn btn-success" id="encryptBtn">
                <i class="fas fa-share-alt"></i> 分享信息
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="result-container" id="resultContainer">
      <h2 class="section-title">
        <i class="fas fa-check-circle"></i> 加密结果
      </h2>

      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> 
        复制下方链接分享给他人，<span id="keyNotice">已包含解密密钥，可直接打开。</span>
      </div>

      <div class="result-group">
        <span class="result-label">加密链接</span>
        <div class="result-value" id="encryptedUrl">
          <span id="urlValue"></span>
          <span class="copy-btn" onclick="copyToClipboard('urlValue')">
            <i class="fas fa-copy"></i> 复制
          </span>
        </div>
      </div>

      <div class="result-group">
        <span class="result-label">加密秘钥 (请安全保存)</span>
        <div class="result-value" id="decryptionKey">
          <span id="keyValue"></span>
          <span class="copy-btn" onclick="copyToClipboard('keyValue')">
            <i class="fas fa-copy"></i> 复制
          </span>
        </div>
      </div>

      <div class="preview-link">
        <a href="#" id="previewLink" target="_blank">
          <i class="fas fa-external-link-alt"></i> 打开预览页面
        </a>
      </div>

      <div class="actions">
        <button class="btn btn-warning" id="backToFormBtn">
          <i class="fas fa-arrow-left"></i> 返回编辑
        </button>
      </div>
    </div>
  </div>
  
  <!-- 备注编辑模态框 -->
  <div id="notesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-edit"></i> 编辑账号备注</h2>
        <span class="modal-close" id="closeNotesModal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="notes-container">
          <div class="notes-input">
            <h3>编辑 <small>(支持Markdown语法)</small></h3>
            <textarea id="accountNotes" placeholder="在此输入备注信息，支持Markdown语法" oninput="updateNotesPreview()"></textarea>
          </div>
          <div class="notes-preview">
            <div class="preview-title">预览</div>
            <div id="notesPreview" class="markdown-content"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="saveNotesBtn">
          <i class="fas fa-save"></i> 保存备注
        </button>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 邮箱账号加密工具 | 安全 • 私密 • 便捷</p>
  </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // DOM元素
    const emailPrefixInput = document.getElementById('emailPrefix');
    const emailDomainSelect = document.getElementById('emailDomain');
    const generateRandomEmailBtn = document.getElementById('generateRandomEmail');
    const encryptionKeyInput = document.getElementById('encryptionKey');
    const generateKeyBtn = document.getElementById('generateKeyBtn');
    const resetBtn = document.getElementById('resetBtn');
    const encryptBtn = document.getElementById('encryptBtn');
    const resultContainer = document.getElementById('resultContainer');
    const urlValueElement = document.getElementById('urlValue');
    const keyValueElement = document.getElementById('keyValue');
    const previewLink = document.getElementById('previewLink');
    const backToFormBtn = document.getElementById('backToFormBtn');
    const accountForm = document.getElementById('accountForm');
    
    // 备注相关元素
    const notesModal = document.getElementById('notesModal');
    const openNotesBtn = document.getElementById('openNotesBtn');
    const closeNotesModal = document.getElementById('closeNotesModal');
    const saveNotesBtn = document.getElementById('saveNotesBtn');
    const accountNotesTextarea = document.getElementById('accountNotes');
    const notesPreview = document.getElementById('notesPreview');
    const notesIndicator = document.getElementById('notesIndicator');

    // 生成随机邮箱前缀
    function generateRandomEmailPrefix() {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      // 生成6-10个字符的随机前缀
      const length = Math.floor(Math.random() * 5) + 6;
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    
    // 随机邮箱生成按钮点击事件
    generateRandomEmailBtn.addEventListener('click', () => {
      emailPrefixInput.value = generateRandomEmailPrefix();
    });
    
    // 监听域名选择变化
    emailDomainSelect.addEventListener('change', function() {
      const customDomainInput = document.getElementById('customDomain');
      if (this.value === 'custom') {
        customDomainInput.style.display = 'block';
        customDomainInput.focus();
      } else {
        customDomainInput.style.display = 'none';
      }
    });
    
    // 获取完整邮箱地址
    function getFullEmail() {
      const prefix = emailPrefixInput.value.trim();
      let domain;
      
      if (emailDomainSelect.value === 'custom') {
        domain = document.getElementById('customDomain').value.trim();
        if (!domain) {
          alert('请输入自定义域名');
          document.getElementById('customDomain').focus();
          return '';
        }
      } else {
        domain = emailDomainSelect.value;
      }
      
      return `${prefix}@${domain}`;
    }

    // 生成随机秘钥
    function generateRandomKey(length = 16) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    
    // 生成强密码
    function generateStrongPassword(length = 16) {
      const uppercase = 'ABCDEFGHJKLMNPQRSTUVWXYZ';  // 避免容易混淆的字符
      const lowercase = 'abcdefghijkmnopqrstuvwxyz'; // 避免容易混淆的字符
      const numbers = '23456789';                    // 避免容易混淆的数字
      const symbols = '!@#$%^&*_+-=';
      
      const allChars = uppercase + lowercase + numbers + symbols;
      let password = '';
      
      // 确保密码包含各种字符类型
      password += uppercase.charAt(Math.floor(Math.random() * uppercase.length));
      password += lowercase.charAt(Math.floor(Math.random() * lowercase.length));
      password += numbers.charAt(Math.floor(Math.random() * numbers.length));
      password += symbols.charAt(Math.floor(Math.random() * symbols.length));
      
      // 生成剩余长度的随机字符
      for (let i = password.length; i < length; i++) {
        password += allChars.charAt(Math.floor(Math.random() * allChars.length));
      }
      
      // 打乱密码字符顺序
      return password.split('').sort(() => 0.5 - Math.random()).join('');
    }

    // 复制到剪贴板
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      const text = element.textContent;
      
      navigator.clipboard.writeText(text)
        .then(() => {
          // 显示复制成功效果
          const copyBtn = element.nextElementSibling;
          const originalText = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fas fa-check"></i> 已复制';
          
          setTimeout(() => {
            copyBtn.innerHTML = originalText;
          }, 2000);
        })
        .catch(err => {
          console.error('复制失败:', err);
          alert('复制失败，请手动复制');
        });
    }

    // 加密数据
    function encryptData(data, key) {
      try {
        return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
      } catch (error) {
        console.error('加密失败:', error);
        return null;
      }
    }

    // 解析TOTP URI
    document.getElementById('parseUriBtn').addEventListener('click', function() {
      const uri = document.getElementById('totpUri').value.trim();
      if (!uri) {
        showToast('请输入TOTP URI', 'error');
        return;
      }
      
      try {
        // 检查URI格式
        if (!uri.startsWith('otpauth://totp/')) {
          showToast('无效的TOTP URI格式', 'error');
          return;
        }
        
        // 解析URI
        const url = new URL(uri);
        
        // 提取账号信息
        let account = decodeURIComponent(url.pathname.substring(6)); // 移除 /totp/
        const colonIndex = account.indexOf(':');
        let emailAccount = '';
        
        if (colonIndex > -1) {
          // 格式为 Issuer:Account
          const issuer = account.substring(0, colonIndex);
          emailAccount = account.substring(colonIndex + 1);
        } else {
          // 没有issuer，整个值就是账号
          emailAccount = account;
        }
        
        // 提取secret
        const params = new URLSearchParams(url.search);
        const secret = params.get('secret');
        
        if (!secret) {
          showToast('URI中没有找到Secret参数', 'error');
          return;
        }
        
        // 填充表单
        if (emailAccount.includes('@')) {
          // 如果是邮箱格式，分解为前缀和域名
          const parts = emailAccount.split('@');
          if (parts.length === 2) {
            document.getElementById('emailPrefix').value = parts[0];
            
            if (document.getElementById('emailDomain').querySelector(`option[value="${parts[1]}"]`)) {
              document.getElementById('emailDomain').value = parts[1];
              document.getElementById('customDomain').style.display = 'none';
            } else {
              document.getElementById('emailDomain').value = 'custom';
              document.getElementById('customDomain').style.display = 'block';
              document.getElementById('customDomain').value = parts[1];
            }
          }
        }
        
        document.getElementById('totpSecret').value = secret;
        updateTFAPreview(); // 更新预览
        
        showToast('成功解析TOTP URI', 'success');
      } catch (e) {
        console.error('解析URI失败:', e);
        showToast('解析URI失败: ' + e.message, 'error');
      }
    });
    
    // 显示提示消息
    function showToast(message, type = 'success') {
      // 创建toast元素
      const toast = document.createElement('div');
      toast.style.position = 'fixed';
      toast.style.bottom = '30px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.padding = '12px 25px';
      toast.style.borderRadius = '50px';
      toast.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
      toast.style.zIndex = '1000';
      toast.style.fontWeight = 'bold';
      toast.style.display = 'flex';
      toast.style.alignItems = 'center';
      toast.style.gap = '10px';
      
      // 设置类型样式
      if (type === 'error') {
        toast.style.backgroundColor = 'var(--accent-color)';
        toast.style.color = 'white';
        toast.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
      } else {
        toast.style.backgroundColor = 'var(--secondary-color)';
        toast.style.color = 'white';
        toast.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
      }
      
      document.body.appendChild(toast);
      
      // 动画效果
      setTimeout(() => {
        toast.style.transition = 'opacity 0.3s, transform 0.3s';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(20px)';
      }, 2000);
      
      // 移除元素
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 2300);
    }
    
    // 更新Markdown预览
    function updateNotesPreview() {
      const notes = document.getElementById('accountNotes').value;
      const preview = document.getElementById('notesPreview');
      
      if (notes.trim() === '') {
        preview.innerHTML = '<em style="color: var(--text-light);">预览将显示在这里...</em>';
      } else {
        preview.innerHTML = marked.parse(notes);
      }
    }

    // 从表单收集数据
    function collectFormData() {
      // 获取原始TOTP URI
      const totpUriValue = document.getElementById('totpUri').value.trim();
      
      return {
        googleAccount: getFullEmail(),
        googlePassword: document.getElementById('googlePassword').value,
        recoveryPhone: document.getElementById('recoveryPhone').value,
        recoveryEmail: document.getElementById('recoveryEmail').value,
        totpSecret: document.getElementById('totpSecret').value,
        totpUri: totpUriValue, // 保存完整的原始URI
        registrationTime: document.getElementById('registrationTime').value,
        registrationIP: document.getElementById('registrationIP').value,
        cookieInfo: document.getElementById('cookieInfo').value,
        accountNotes: document.getElementById('accountNotes').value // 添加备注字段
      };
    }

    // 生成秘钥按钮事件
    generateKeyBtn.addEventListener('click', () => {
      encryptionKeyInput.value = generateRandomKey();
    });

    // 重置按钮事件
    resetBtn.addEventListener('click', () => {
      if (confirm('确定要重置所有输入的信息吗？')) {
        accountForm.reset();
        emailDomainSelect.value = 'gmail.com';
        document.getElementById('customDomain').style.display = 'none';
        document.getElementById('accountNotes').value = '';
        updateNotesIndicator();
        showToast('已重置所有表单数据');
      }
    });

    // TFA 预览相关函数
    function updateTFAPreview() {
      const secret = document.getElementById('totpSecret').value.trim();
      const preview = document.getElementById('tfaPreview');
      
      if (secret.length > 0) {
        preview.style.display = 'flex';
        generateQRCode(secret);
        updateTOTPCode(secret);
        
        // 设置TOTP定时更新
        if (!window.totpInterval) {
          window.totpInterval = setInterval(() => {
            updateTOTPCode(document.getElementById('totpSecret').value.trim());
          }, 1000);
        }
      } else {
        preview.style.display = 'none';
        if (window.totpInterval) {
          clearInterval(window.totpInterval);
          window.totpInterval = null;
        }
      }
    }
    
    function generateQRCode(secret) {
      if (!secret) return;
      
      const qrcodeElement = document.getElementById('qrcode-preview');
      qrcodeElement.innerHTML = ''; // 清空容器
      
      // 创建TOTP URI
      const account = getFullEmail() || 'user@example.com';
      const issuer = 'Email';
      const otpauthURL = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(account)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}`;
      
      // 生成二维码
      new QRCode(qrcodeElement, {
        text: otpauthURL,
        width: 150,
        height: 150,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }
    
    // TOTP验证码点击复制功能
    function copyTOTP() {
      const totpElement = document.getElementById('totp-code-preview');
      const code = totpElement.textContent;
      
      if (code && code !== '------') {
        navigator.clipboard.writeText(code)
          .then(() => {
            // 显示复制成功效果
            const originalColor = totpElement.style.color;
            totpElement.style.color = 'var(--secondary-color)';
            
            setTimeout(() => {
              totpElement.style.color = originalColor;
            }, 500);
          })
          .catch(err => {
            console.error('复制验证码失败:', err);
            alert('复制验证码失败，请手动复制');
          });
      }
    }

    function updateTOTPCode(secret) {
      if (!secret) {
        document.getElementById('totp-code-preview').textContent = '------';
        document.getElementById('totp-timer').textContent = '剩余时间: 0秒';
        return;
      }
      
      try {
        // Base32解码为十六进制
        const key = base32tohex(secret);
        // 获取30秒间隔的时间戳
        const epoch = Math.round(new Date().getTime() / 1000.0);
        const currentSecond = epoch % 30;
        const remainingSeconds = 30 - currentSecond;
        const time = leftpad(dec2hex(Math.floor(epoch / 30)), 16, '0');
        
        // 使用HMAC-SHA1计算
        const hmacObj = new jsSHA('SHA-1', 'HEX');
        hmacObj.setHMACKey(key, 'HEX');
        hmacObj.update(time);
        const hmac = hmacObj.getHMAC('HEX');
        
        // 计算动态验证码
        const offset = hex2dec(hmac.substring(hmac.length - 1));
        const truncatedHash = (hex2dec(hmac.substr(offset * 2, 8)) & hex2dec('7fffffff')) + '';
        const code = truncatedHash.substr(truncatedHash.length - 6, 6);
        
        document.getElementById('totp-code-preview').textContent = code;
        document.getElementById('totp-timer').textContent = `剩余时间: ${remainingSeconds}秒`;
        
        // 如果即将过期（剩余5秒或更少），改变颜色提醒用户
        if (remainingSeconds <= 5) {
          document.getElementById('totp-timer').style.color = 'var(--accent-color)';
        } else {
          document.getElementById('totp-timer').style.color = '';
        }
      } catch (e) {
        console.error('生成TOTP失败:', e);
        document.getElementById('totp-code-preview').textContent = '------';
        document.getElementById('totp-timer').textContent = '剩余时间: 0秒';
      }
    }
    
    // 工具函数
    function dec2hex(s) { return (s < 15.5 ? '0' : '') + Math.round(s).toString(16); }
    function hex2dec(s) { return parseInt(s, 16); }
    
    function leftpad(s, l, p) { 
      return s.length >= l ? s : Array(l - s.length + 1).join(p) + s; 
    }
    
    function base32tohex(base32) {
      const base32chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = '';
      let hex = '';
      
      // 移除所有填充字符
      base32 = base32.replace(/=+$/, '').toUpperCase();
      
      // 转换为二进制位
      for (let i = 0; i < base32.length; i++) {
        const val = base32chars.indexOf(base32.charAt(i));
        if (val === -1) continue; // 跳过无效字符
        bits += leftpad(val.toString(2), 5, '0');
      }
      
      // 每4位二进制转为一个十六进制字符
      for (let i = 0; i + 4 <= bits.length; i += 4) {
        const chunk = bits.substr(i, 4);
        hex += parseInt(chunk, 2).toString(16);
      }
      
      return hex;
    }
    
    // 为生成密码按钮添加事件监听
    document.getElementById('genPasswordBtn').addEventListener('click', () => {
      const passwordInput = document.getElementById('googlePassword');
      passwordInput.value = generateStrongPassword();
    });
    
    // 处理URL中是否包含密钥的选项
    document.getElementById('includeKeyInUrl').addEventListener('change', function() {
      const keyNotice = document.getElementById('keyNotice');
      if (this.checked) {
        keyNotice.textContent = '已包含解密密钥，可直接打开。';
      } else {
        keyNotice.textContent = '需要手动输入解密密钥才能查看。';
      }
    });
    
    // 分享按钮事件
    encryptBtn.addEventListener('click', () => {
      // 验证表单
      if (!emailPrefixInput.value.trim()) {
        alert('请填写邮箱账号');
        return;
      }
      
      if (!document.getElementById('googlePassword').value.trim()) {
        alert('请填写邮箱密码');
        return;
      }
      
      // 确保有加密秘钥
      if (!encryptionKeyInput.value) {
        encryptionKeyInput.value = generateRandomKey();
      }
      
      // 收集数据
      const formData = collectFormData();
      const encryptionKey = encryptionKeyInput.value;
      
      // 加密数据
      const encryptedData = encryptData(formData, encryptionKey);
      
      if (!encryptedData) {
        alert('加密失败，请重试');
        return;
      }
      
      // 获取当前页面URL的基础路径（使用绝对URL）
      const currentUrl = window.location.href;
      const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
      
      // 根据选项决定是否在URL中包含密钥
      const includeKey = document.getElementById('includeKeyInUrl').checked;
      const url = includeKey ? 
        `${baseUrl}decrypt.html?data=${encodeURIComponent(encryptedData)}&key=${encodeURIComponent(encryptionKey)}` :
        `${baseUrl}decrypt.html?data=${encodeURIComponent(encryptedData)}`;
      
      // 显示结果
      urlValueElement.textContent = url;
      keyValueElement.textContent = encryptionKey;
      previewLink.href = url;
      
      // 更新提示信息
      document.getElementById('keyNotice').textContent = includeKey ? 
        '已包含解密密钥，可直接打开。' : 
        '需要手动输入解密密钥才能查看。';
      
      // 显示结果容器
      resultContainer.style.display = 'block';
      
      // 滚动到结果容器
      resultContainer.scrollIntoView({ behavior: 'smooth' });
    });

    // 返回编辑按钮事件
    backToFormBtn.addEventListener('click', () => {
      resultContainer.style.display = 'none';
    });
    
    // 备注模态框相关逻辑
    openNotesBtn.addEventListener('click', () => {
      notesModal.style.display = 'block';
    });
    
    closeNotesModal.addEventListener('click', () => {
      notesModal.style.display = 'none';
    });
    
    saveNotesBtn.addEventListener('click', () => {
      notesModal.style.display = 'none';
      updateNotesIndicator();
      showToast('备注已保存');
    });
    
    // 更新备注指示器
    function updateNotesIndicator() {
      const notesText = accountNotesTextarea.value.trim();
      if (notesText) {
        const wordCount = notesText.split(/\s+/).filter(Boolean).length;
        const charCount = notesText.length;
        notesIndicator.innerHTML = `<i class="fas fa-check-circle" style="color: var(--secondary-color);"></i> 已添加备注 (${wordCount}词/${charCount}字符)`;
      } else {
        notesIndicator.innerHTML = '';
      }
    }

    // 页面加载时自动生成一个秘钥并初始化Markdown预览
    window.addEventListener('load', () => {
      encryptionKeyInput.value = generateRandomKey();
      document.title = '邮箱账号加密工具';
      updateNotesPreview(); // 初始化Markdown预览
      updateNotesIndicator(); // 初始化备注指示器
    });
  </script>
</body>
</html>